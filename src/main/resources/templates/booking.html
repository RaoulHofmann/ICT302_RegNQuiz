<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title> QuizNGo</title>
    <link rel = "stylesheet" type="text/css"
          href="/resources/css/regNGo.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="/resources/javascript/login.js"></script>
    <script type="text/javascript" src="/resources/javascript/booking.js"></script>
</head>
<body onload="booking_info();">
    <th:block th:if= "${booking != null}">
        <h1>Attendance Code:</h1>
        <h1 th:text="${booking.attendanceCode}"></h1>
        <th:block th:if="${finished == null}">
            <th:block th:if= "${questions == null}">
                <a href="javascript: document.startQuestions.submit()" role="button" id="startQuestions">Display Question</a>
                <form name="startQuestions" th:action="@{/booking/{id}/question(id=${booking.bookingID})}" method="post" th:hidden="true">
                    <input hidden type="submit" value="Display Question"/>
                </form>
            </th:block>
            <th:block th:if= "${questions != null}">
                <a href="javascript: document.nextQuestions.submit()" role="button" id="nextQuestions">Next Question</a>
                <form name="nextQuestions" th:action="@{/booking/{id}/question/{qid}(id=${booking.bookingID}, qid=${questionid})}" method="post" th:hidden="true">
                    <input hidden type="submit" value="nextQuestions"/>
                </form>
            </th:block>
        </th:block>
    </th:block>
    <script th:inline="javascript" th:if="${timer != null}">
        var x = setInterval( function()
       {
          var timer = $('.js-timeout').html();
          var seconds = timer;
          if(seconds > 0){
            seconds -= 1;
          }

          $('.js-timeout').html(seconds);

          if (seconds <= 0)
          {
            clearInterval(x);
            $.ajax({
                type: "POST",
                url : '/booking/settimeout',
                data: { timer: 1, bookingID:
                        [# th:if="${booking != null }"]
                            /*[[${booking.bookingID}]]*/ 'bookingID'
                        [/]
                        }
            });
          }
      }, 1000);
    </script>

    <div id="questions" th:if= "${questions != null}">
        <p class="timer" th:if="${timer != null}">Time will end in <span class="js-timeout" id="js-timeout" th:text="${timer}"></span></p><br/>
        <span th:text="${questions.description}"></span>
        <table>
            <th:block th:each="multipleChoice : ${multipleChoices}">
                <tr>
                    <td th:text="${multipleChoice.description}"></td>
                </tr>
            </th:block>
        </table>
    </div>
    <th:block th:if="${finished != null}">
        <span>
            Quiz Finished
        </span>
    </th:block>

    <script th:inline="javascript" th:if="${booking != null}">
        var interval;
        function getAttendance() {
            $.ajax({
                type: "POST",
                url : '/booking/getattendance',
                data: { bookingID:
                        [# th:if="${booking != null }"]
                            /*[[${booking.bookingID}]]*/ 'bookingID'
                        [/]
                    },
                success: function (data) {
                    $('#attendance_count').html("Attending: "+data);
                    interval = setTimeout(getAttendance, 1000);
                }
            });
        }
        getAttendance();
    </script>

    <script th:inline="javascript" th:if="${booking != null}">
        var studentAnswerInt;
        function getStudentAnswers() {
            $.ajax({
                type: "POST",
                url : '/booking/getstudentanswers',
                data: { bookingID:
                        [# th:if="${booking != null }"]
                            /*[[${booking.bookingID}]]*/ 'bookingID'
                        [/]
                    },
                success: function (data) {
                    if(data.length != 0){
                        $('#answerCounter').html(data);
                    }
                    studentAnswerInt = setTimeout(getStudentAnswers, 1000);
                }
            });
        }
        getStudentAnswers();
    </script>

    <h4 id="attendance_count"></h4>
    <div id="answerCounter" th:fragment="studentAnswer">
        <table>
            <th:block >
                <tr th:each="studentAnswer : ${studentAnswers}">
                    <th th:text="${studentAnswer.value}"></th>
                    <td th:text="${studentAnswer.key}"></td>
                </tr>
            </th:block>
        </table>
    </div>
    <input type="button"  onclick="location.href='/booking/'" value="Back" >
</body>
</html>

